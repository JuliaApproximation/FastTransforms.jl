import Base.Math: @horner

const sqrtpi = 1.772453850905516027298

# Pochhhammer symbol (x)â‚™ for the rising factorial. From ApproxFun.

function pochhammer(x::Number,n::Integer)
    ret = one(x)
    if nâ‰¥0
        for i=0:n-1
            ret *= x+i
        end
    else
        ret /= pochhammer(x+n,-n)
    end
    ret
end

pochhammer{T<:Number}(x::AbstractArray{T,1},n::Integer) = [pochhammer(x[i],n) for i=1:length(x)]
pochhammer{T<:Number}(x::AbstractArray{T,2},n::Integer) = [pochhammer(x[i,j],n) for i=1:size(x,1),j=1:size(x,2)]
pochhammer{T<:Number}(x::AbstractArray{T},n::Integer) = reshape([ pochhammer(x[i],n) for i in eachindex(x) ], size(x))

pochhammer(x::Number,n::Number) = gamma(x+n)/gamma(x)
pochhammer{T<:Number}(x::AbstractArray{T},n::Number) = gamma(x+n)./gamma(x)

function pochhammer{T<:Real}(x::Number,n::UnitRange{T})
    ret = Vector{promote_type(typeof(x),T)}(length(n))
    ret[1] = pochhammer(x,first(n))
    for i=2:length(n)
        ret[i] = (x+n[i]-1)*ret[i-1]
    end
    ret
end

# Stirling series for Î“(z)

stirlingseries(z) = gamma(z)*sqrt((z/Ï€)/2)*exp(z)/z^z

function stirlingseries(z::Float64)
    if z â‰¥ 3274.12075200175       # N =  4
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03)
    elseif z â‰¥ 590.1021805526798  # N =  5
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04)
    elseif z â‰¥ 195.81733962412835 # N =  6
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04)
    elseif z â‰¥ 91.4692823071966   # N =  7
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05)
    elseif z â‰¥ 52.70218954633605  # N =  8
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04)
    elseif z â‰¥ 34.84031591198865  # N =  9
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05)
    elseif z â‰¥ 25.3173982783047   # N = 10
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04)
    elseif z â‰¥ 19.685015283078513 # N = 11
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05)
    elseif z â‰¥ 16.088669099569266 # N = 12
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03)
    elseif z â‰¥ 13.655055978888104 # N = 13
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03,-1.625162627839158168986351239802709981058725919322518870384880567497861723029629e-04)
    elseif z â‰¥ 11.93238782087875  # N = 14
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03,-1.625162627839158168986351239802709981058725919322518870384880567497861723029629e-04,6.403362833808069794823638090265795830401894093962864676301495665407594627808272e-03)
    elseif z â‰¥ 10.668852439197263 # N = 15
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03,-1.625162627839158168986351239802709981058725919322518870384880567497861723029629e-04,6.403362833808069794823638090265795830401894093962864676301495665407594627808272e-03,5.40164767892604515180467508570241735547254415979217175042122014107572377089416e-04)
    elseif z â‰¥ 9.715358216638403  # N = 16
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03,-1.625162627839158168986351239802709981058725919322518870384880567497861723029629e-04,6.403362833808069794823638090265795830401894093962864676301495665407594627808272e-03,5.40164767892604515180467508570241735547254415979217175042122014107572377089416e-04,-2.952788094569911906397482537591847109556414086866728343527599982978874278241523e-02)
    elseif z â‰¥ 8.979120323411497  # N = 17
        @horner(inv(z),1.0,8.333333333333333333333333333333333333333333333333333333333333333333333333333369e-02,3.472222222222222222222222222222222222222222222222222222222222222222222222222215e-03,-2.681327160493827160493827160493827160493827160493827160493827160493827160493839e-03,-2.294720936213991769547325102880658436213991769547325102880658436213991769547334e-04,7.840392217200666274740348814422888496962571036645110719184793258867332941407013e-04,6.972813758365857774293988285757833082935963594399808391577938903041783700219962e-05,-5.921664373536938828648362256044011873915851967978168252516675013245657964450818e-04,-5.171790908260592193370578430020588228178534534272988776875379527414278214461134e-05,8.39498720672087279993357516764983445198182111593007628503572550042430988763692e-04,7.204895416020010559085719302250150520634517379754789525044898104721705621361993e-05,-1.914438498565477526500898858328522544876893578953503896119485486078256623676663e-03,-1.625162627839158168986351239802709981058725919322518870384880567497861723029629e-04,6.403362833808069794823638090265795830401894093962864676301495665407594627808272e-03,5.40164767892604515180467508570241735547254415979217175042122014107572377089416e-04,-2.952788094569911906397482537591847109556414086866728343527599982978874278241523e-02,-2.481743600264997908117784815628212251392939090210182309899976306369140724437755e-03)
    else
        gamma(z)*sqrt(z/2Ï€)*exp(z)/z^z
    end
end

@vectorize_1arg Number stirlingseries

stirlingremainder(z::Number,N::Int) = (1+zeta(N))*gamma(N)/((2Ï€)^(N+1)*z^N)/stirlingseries(z)
stirlingremainder{T<:Number}(z::AbstractVector{T},N::Int) = (1+zeta(N))*gamma(N)/(2Ï€)^(N+1)./z.^N./stirlingseries(z)

Aratio(n::Int,Î±::Float64,Î²::Float64) = exp((n/2+Î±+1/4)*log1p(-Î²/(n+Î±+Î²+1))+(n/2+Î²+1/4)*log1p(-Î±/(n+Î±+Î²+1))+(n/2+1/4)*log1p(Î±/(n+1))+(n/2+1/4)*log1p(Î²/(n+1)))
Aratio(n::Number,Î±::Number,Î²::Number) = (1+(Î±+1)/n)^(n+Î±+1/2)*(1+(Î²+1)/n)^(n+Î²+1/2)/(1+(Î±+Î²+1)/n)^(n+Î±+Î²+1/2)/(1+(zero(Î±)+zero(Î²))/n)^(n+1/2)
Aratio(n::AbstractVector,Î±::Number,Î²::Number) = [ Aratio(n[i],Î±,Î²) for i=1:length(n) ]

Cratio(n::Int,Î±::Float64,Î²::Float64) = exp((n+Î±+1/2)*log1p((Î±-Î²)/(2n+Î±+Î²+2))+(n+Î²+1/2)*log1p((Î²-Î±)/(2n+Î±+Î²+2))-log1p((Î±+Î²+2)/2n)/2)/sqrt(n)
Cratio(n::Number,Î±::Number,Î²::Number) = n^(-1/2)*(1+(Î±+1)/n)^(n+Î±+1/2)*(1+(Î²+1)/n)^(n+Î²+1/2)/(1+(Î±+Î²+2)/2n)^(2n+Î±+Î²+3/2)
Cratio(n::AbstractVector,Î±::Number,Î²::Number) = [ Cratio(n[i],Î±,Î²) for i=1:length(n) ]


AnÎ±Î²(n::Number,Î±::Number,Î²::Number) = 2^(Î±+Î²+1)/(2n+Î±+Î²+1)*exp(lgamma(n+Î±+1)-lgamma(n+Î±+Î²+1)+lgamma(n+Î²+1)-lgamma(n+1))
function AnÎ±Î²(n::Integer,Î±::Number,Î²::Number)
    if n==0
        2^(Î±+Î²+1)*beta(Î±+1,Î²+1)
    else
        val = AnÎ±Î²(0,Î±,Î²)
        for i=1:n
            val *= (i+Î±)*(i+Î²)/(i+Î±+Î²)/i*(2i+Î±+Î²-1)/(2i+Î±+Î²+1)
        end
        val
    end
end

function AnÎ±Î²(n::Integer,Î±::Float64,Î²::Float64)
    if n+min(Î±,Î²,Î±+Î²,0) â‰¥ 7.979120323411497
        2.^(Î±+Î²+1)/(2n+Î±+Î²+1)*stirlingseries(n+Î±+1)*Aratio(n,Î±,Î²)/stirlingseries(n+Î±+Î²+1)*stirlingseries(n+Î²+1)/stirlingseries(n+one(Float64))
    else
        (n+1)*(n+Î±+Î²+1)/(n+Î±+1)/(n+Î²+1)*AnÎ±Î²(n+1,Î±,Î²)*((2n+Î±+Î²+3)/(2n+Î±+Î²+1))
    end
end

AnÎ±Î²{T<:Integer}(n::AbstractVector{T},Î±::Number,Î²::Number) = [ AnÎ±Î²(n[i],Î±,Î²) for i=1:length(n) ]
AnÎ±Î²{T<:Integer}(n::AbstractMatrix{T},Î±::Number,Î²::Number) = [ AnÎ±Î²(n[i,j],Î±,Î²) for i=1:size(n,1), j=1:size(n,2) ]


#
# This uses the asymptotic series for Ï„ in Appendix B of
#
# I. Bogaert and B. Michiels and J. Fostier, ð’ª(1) computation of Legendre polynomials and Gauss--Legendre nodes and weights for parallel computing, SIAM J. Sci. Comput., 34:C83--C101, 2012.
#
Cx(x::Number) = exp(lgamma(x+1/2)-lgamma(x+1))
function Cx(x::Float64)
    if x > 9.84475
        xp = x+0.25
        @horner(inv(xp^2),1.0,-1.5625e-02,2.5634765625e-03,-1.2798309326171875e-03,1.343511044979095458984375e-03,-2.432896639220416545867919921875e-03,6.7542375336415716446936130523681640625e-03)/sqrt(xp)
    else
        (x+1.0)*Cx(x+1.0)/(x+0.5)
    end
end
@vectorize_1arg Number Cx

CnÎ»(n::Integer,Î»::Float64) = 2^Î»/sqrtpi*Cx(n+Î»)
CnÎ»(n::Integer,Î»::Number) = 2^Î»/sqrt(convert(typeof(Î»),Ï€))*Cx(n+Î»)
function CnÎ»{T<:Integer}(n::UnitRange{T},Î»::Number)
    ret = Vector{typeof(Î»)}(length(n))
    ret[1] = CnÎ»(first(n),Î»)
    for i=2:length(n)
        ret[i] = (n[i]+Î»-1/2)/(n[i]+Î»)*ret[i-1]
    end
    ret
end

CnÎ»{T<:Integer}(n::AbstractVector{T},Î»::Number) = [ CnÎ»(n[i],Î») for i=1:length(n) ]
CnÎ»{T<:Integer}(n::AbstractMatrix{T},Î»::Number) = [ CnÎ»(n[i,j],Î») for i=1:size(n,1), j=1:size(n,2) ]

function CnmÎ»(n::Integer,m::Integer,Î»::Number)
    if m == 0
        CnÎ»(n,Î»)
    else
        (Î»+m-1)/2/m*(m-Î»)/(n+Î»+m)*CnmÎ»(n,m-1,Î»)
    end
end

CnmÎ»{T<:Integer}(n::AbstractVector{T},m::Integer,Î»::Number) = [ CnmÎ»(n[i],m,Î») for i=1:length(n) ]


function CnÎ±Î²(n::Integer,Î±::Number,Î²::Number)
    if n==0
        2^(Î±+Î²+1)*beta(Î±+1,Î²+1)/Ï€
    else
        val = CnÎ±Î²(0,Î±,Î²)
        for i=1:n
            val *= (i+Î±)*(i+Î²)/(i+(Î±+Î²+1)/2)/(i+(Î±+Î²)/2)
        end
        val
    end
end

function CnÎ±Î²(n::Integer,Î±::Float64,Î²::Float64)
    if n+min(Î±,Î²) â‰¥ 7.979120323411497
        stirlingseries(n+Î±+1)/sqrtpi/stirlingseries(2n+Î±+Î²+2)*Cratio(n,Î±,Î²)*stirlingseries(n+Î²+1)
    else
        (n+(Î±+Î²+3)/2)/(n+Î²+1)*(n+(Î±+Î²+2)/2)/(n+Î±+1)*CnÎ±Î²(n+1,Î±,Î²)
    end
end

CnÎ±Î²{T<:Integer}(n::AbstractVector{T},Î±::Number,Î²::Number) = [ CnÎ±Î²(n[i],Î±,Î²) for i=1:length(n) ]
CnÎ±Î²{T<:Integer}(n::AbstractMatrix{T},Î±::Number,Î²::Number) = [ CnÎ±Î²(n[i,j],Î±,Î²) for i=1:size(n,1), j=1:size(n,2) ]

function CnmÎ±Î²(n::Integer,m::Integer,Î±::Number,Î²::Number)
    if m == 0
        CnÎ±Î²(n,Î±,Î²)
    else
        CnmÎ±Î²(n,m-1,Î±,Î²)/2(2n+Î±+Î²+m+1)
    end
end

CnmÎ±Î²{T<:Integer}(n::AbstractVector{T},m::Integer,Î±::Number,Î²::Number) = [ CnmÎ±Î²(n[i],m,Î±,Î²) for i=1:length(n) ]
CnmÎ±Î²{T<:Integer}(n::AbstractMatrix{T},m::Integer,Î±::Number,Î²::Number) = [ CnmÎ±Î²(n[i,j],m,Î±,Î²) for i=1:size(n,1), j=1:size(n,2) ]

function CnmÎ±Î²{T<:Number}(n::Integer,m::Integer,Î±::AbstractArray{T},Î²::AbstractArray{T})
    shp = promote_shape(size(Î±),size(Î²))
    reshape([ CnmÎ±Î²(n,m,Î±[i],Î²[i]) for i in eachindex(Î±,Î²) ], shp)
end


function absf(Î±::Number,Î²::Number,m::Int,Î¸::Number)
    ret = zero(Î¸)
    for l=0:m
        ret += pochhammer(1/2+Î±,l)*pochhammer(1/2-Î±,l)*pochhammer(1/2+Î²,m-l)*pochhammer(1/2-Î²,m-l)/factorial(l)/factorial(m-l)/sinpi(Î¸/2)^(l+Î±+1/2)/cospi(Î¸/2)^(m-l+Î²+1/2)
    end
    ret
end

function absf{T<:Number}(Î±::AbstractArray{T},Î²::AbstractArray{T},m::Int,Î¸::Number)
    shp = promote_shape(size(Î±),size(Î²))
    reshape([ absf(Î±[i],Î²[i],m,Î¸) for i in eachindex(Î±,Î²) ], shp)
end

function absf{T<:Number}(Î±::Number,Î²::Number,m::Int,Î¸::AbstractArray{T,1})
    ret = zero(Î¸)
    cfs = zeros(T,m+1)
    for l=0:m
        @inbounds cfs[l+1] = pochhammer(1/2+Î±,l)*pochhammer(1/2-Î±,l)*pochhammer(1/2+Î²,m-l)*pochhammer(1/2-Î²,m-l)/factorial(l)/factorial(m-l)
    end
    @inbounds for i=1:length(Î¸),l=0:m
        ret[i] += cfs[l+1]/sinpi(Î¸[i]/2)^(l+Î±+1/2)/cospi(Î¸[i]/2)^(m-l+Î²+1/2)
    end
    ret
end
absf{T<:Number}(Î±::Number,Î²::Number,m::Int,Î¸::AbstractArray{T,2}) = [ absf(Î±,Î²,m,Î¸[i,j]) for i=1:size(Î¸,1), j=1:size(Î¸,2) ]
absf{T<:Number}(Î±::Number,Î²::Number,m::Int,Î¸::AbstractArray{T}) = reshape([ absf(Î±,Î²,m,Î¸[i]) for i in eachindex(Î¸) ], size(Î¸))

function compute_absf!{T<:AbstractFloat}(ret::Vector{T},cfs::Matrix{T},Î±::T,Î²::T,tempcos::Vector{T},tempsin::Vector{T},tempcosÎ²sinÎ±::Vector{T},m::Int)
    @inbounds for i=1:length(ret)
        temp = inv(tempcos[i]^m*tempcosÎ²sinÎ±[i])
        ret[i] = cfs[m+1,1]*temp
        for l=1:m
            temp *= tempcos[i]/tempsin[i]
            ret[i] += cfs[m+1,l+1]*temp
        end
    end
    ret
end

function compute_absf!{T<:AbstractFloat}(ret::Vector{T},tempsin::Vector{T},tempsinÎ»::Vector{T},m::Int)
    for i=1:length(ret)
        @inbounds ret[i] = inv(tempsin[i]^m*tempsinÎ»[i])
    end
    ret
end

function compute_umvm!{T<:AbstractFloat}(um::Vector{T},vm::Vector{T},cfs::Matrix{T},Î±::T,Î²::T,tempcos::Vector{T},tempsin::Vector{T},tempcosÎ²sinÎ±::Vector{T},m::Int,Î¸::Vector{T},ir::UnitRange{Int64})
    @inbounds for i in ir
        temp = inv(tempcos[i]^m*tempcosÎ²sinÎ±[i])
        Ï‘ = (Î±+1/2)/2-(Î±+Î²+m+1)*Î¸[i]/2
        um[i] = cfs[m+1,1]*cospi(Ï‘)*temp
        vm[i] = cfs[m+1,1]*sinpi(Ï‘)*temp
        @inbounds for l=1:m
            temp *= tempcos[i]/tempsin[i]
            Ï‘ = (Î±+l+1/2)/2-(Î±+Î²+m+1)*Î¸[i]/2
            um[i] += cfs[m+1,l+1]*cospi(Ï‘)*temp
            vm[i] += cfs[m+1,l+1]*sinpi(Ï‘)*temp
        end
    end
end

function compute_umvm!{T<:AbstractFloat}(um::Vector{T},vm::Vector{T},Î»::T,tempsin::Vector{T},tempsinÎ»::Vector{T},m::Int,Î¸::Vector{T},ir::UnitRange{Int64})
    @inbounds for i in ir
        temp = inv(tempsin[i]^m*tempsinÎ»[i])
        Ï‘ = (m+Î»)*(1/2-Î¸[i])
        um[i] = cospi(Ï‘)*temp
        vm[i] = sinpi(Ï‘)*temp
    end
end

function findmindices!{T<:AbstractFloat}(RÎ±Î²jm::Vector{T},cfs::Matrix{T},Î±::T,Î²::T,j::Int,m::Int,tempcos::Vector{T},tempsin::Vector{T},tempcosÎ²sinÎ±::Vector{T})
    compute_absf!(RÎ±Î²jm,cfs,Î±,Î²,tempcos,tempsin,tempcosÎ²sinÎ±,m)
    scale!(RÎ±Î²jm,CnmÎ±Î²(j,m,Î±,Î²))
    rmin,imin = findmin(RÎ±Î²jm)
    if rmin < eps(T)
        iâ‚ = imin-1
        while iâ‚ â‰¥ 3
            if RÎ±Î²jm[iâ‚] < eps(T)
                iâ‚-=1
            else
                break
            end
        end
        iâ‚‚ = imin+1
        while iâ‚‚ â‰¤ length(RÎ±Î²jm)-2
            if RÎ±Î²jm[iâ‚‚] < eps(T)
                iâ‚‚+=1
            else
                break
            end
        end
        return iâ‚,iâ‚‚
    else
        return 1,0# error("There are no indices such that the interior asymptotic formula is valid.")# but adding an error is type-unstable :(.
    end
end

function findmindices!{T<:AbstractFloat}(RÎ±Î²jm::Vector{T},Î»::T,j::Int,m::Int,tempsin::Vector{T},tempsinÎ»::Vector{T})
    compute_absf!(RÎ±Î²jm,tempsin,tempsinÎ»,m)
    scale!(RÎ±Î²jm,CnmÎ»(j,m,Î»))
    rmin,imin = findmin(RÎ±Î²jm)
    if rmin < eps(T)
        iâ‚ = imin-1
        while iâ‚ â‰¥ 3
            if RÎ±Î²jm[iâ‚] < eps(T)
                iâ‚-=1
            else
                break
            end
        end
        iâ‚‚ = imin+1
        while iâ‚‚ â‰¤ length(RÎ±Î²jm)-2
            if RÎ±Î²jm[iâ‚‚] < eps(T)
                iâ‚‚+=1
            else
                break
            end
        end
        return iâ‚,iâ‚‚
    else
        return 1,0# error("There are no indices such that the interior asymptotic formula is valid.")# but adding an error is type-unstable :(.
    end
end

# initialization methods

function init_cfs{T<:AbstractFloat}(Î±::T,Î²::T,M::Int)
    cfs = zeros(T,M+1,M+1)
    @inbounds for m=0:M,l=0:m
        cfs[m+1,l+1] = pochhammer(1/2+Î±,l)*pochhammer(1/2-Î±,l)*pochhammer(1/2+Î²,m-l)*pochhammer(1/2-Î²,m-l)/factorial(l)/factorial(m-l)
    end
    cfs
end

function init_câ‚câ‚‚!(câ‚::Vector,câ‚‚::Vector,a::Vector,b::Vector,jâ‚::Int,jâ‚‚::Int)
    @inbounds for j=1:jâ‚-1 câ‚[j] = 0 end
    @inbounds for j=jâ‚:jâ‚‚ câ‚[j] = a[j]*b[j] end
    @inbounds for j=jâ‚‚+1:length(câ‚) câ‚[j] = 0 end
    copy!(câ‚‚,câ‚)
end

function init_câ‚câ‚‚!(câ‚::Vector,câ‚‚::Vector,u::Vector,v::Vector,c::Vector,iâ‚::Int,iâ‚‚::Int)
    @inbounds for i=1:iâ‚-1
        câ‚[i] = 0
        câ‚‚[i] = 0
    end
    @inbounds for i=iâ‚:iâ‚‚
        câ‚[i] = u[i]*c[i]
        câ‚‚[i] = v[i]*c[i]
    end
    @inbounds for i=iâ‚‚+1:length(câ‚)
        câ‚[i] = 0
        câ‚‚[i] = 0
    end
end

#
# Modified Chebyshev moments of the first and second kind with respect to the Jacobi weight
#
# âˆ«-â‚Â¹ T_n(x) (1-x)^Î±(1+x)^Î² dx,  and  âˆ«-â‚Â¹ U_n(x) (1-x)^Î±(1+x)^Î² dx.
#


function chebyshevjacobimoments1{T<:AbstractFloat}(N::Int,Î±::T,Î²::T)
    Î¼ = zeros(T,N)
    N > 0 && (Î¼[1] = 2.^(Î±+Î²+1)*beta(Î±+1,Î²+1))
    if N > 1
        Î¼[2] = Î¼[1]*(Î²-Î±)/(Î±+Î²+2)
        for i=1:N-2
            @inbounds Î¼[i+2] = (2(Î²-Î±)*Î¼[i+1]-(Î±+Î²-i+2)*Î¼[i])/(Î±+Î²+i+2)
        end
    end
    Î¼
end

function chebyshevjacobimoments2{T<:AbstractFloat}(N::Int,Î±::T,Î²::T)
    Î¼ = zeros(T,N)
    N > 0 && (Î¼[1] = 2.^(Î±+Î²+1)*beta(Î±+1,Î²+1))
    if N > 1
        Î¼[2] = 2Î¼[1]*(Î²-Î±)/(Î±+Î²+2)
        for i=1:N-2
            @inbounds Î¼[i+2] = (2(Î²-Î±)*Î¼[i+1]-(Î±+Î²-i)*Î¼[i])/(Î±+Î²+i+2)
        end
    end
    Î¼
end

# Compute the bi-diagonal increment/decrement operators to incrementally change Jacobi bases in-place.
## TODO: check incrementÎ±Î²! and decrementÎ±Î²!.
# incrementÎ±! : domain space is Pâ‚™^(Î±,Î²), and range space Pâ‚™^(Î±+1,Î²)
# incrementÎ²! : domain space is Pâ‚™^(Î±,Î²), and range space Pâ‚™^(Î±,Î²+1)
# incrementÎ±Î²! : domain space is Pâ‚™^(Î±,Î±), and range space Pâ‚™^(Î±+1,Î±+1)
# decrementÎ±! : domain space is Pâ‚™^(Î±,Î²), and range space Pâ‚™^(Î±-1,Î²)
# decrementÎ²! : domain space is Pâ‚™^(Î±,Î²), and range space Pâ‚™^(Î±,Î²-1)
# decrementÎ±Î²! : domain space is Pâ‚™^(Î±,Î±), and range space Pâ‚™^(Î±-1,Î±-1)

function incrementÎ±!(c::AbstractVector,Î±,Î²)
    Î±Î²,N = Î±+Î²,length(c)
    N > 1 && (c[1] -= (Î²+1)/(Î±Î²+3)*c[2])
    @inbounds for i=2:N-1 c[i] = (Î±Î²+i)/(Î±Î²+2i-1)*c[i] - (Î²+i)/(Î±Î²+2i+1)*c[i+1] end
    N > 1 && (c[N] *= (Î±Î²+N)/(Î±Î²+2N-1))
    c
end

function incrementÎ²!(c::AbstractVector,Î±,Î²)
    Î±Î²,N = Î±+Î²,length(c)
    N > 1 && (c[1] += (Î±+1)/(Î±Î²+3)*c[2])
    @inbounds for i=2:N-1 c[i] = (Î±Î²+i)/(Î±Î²+2i-1)*c[i] + (Î±+i)/(Î±Î²+2i+1)*c[i+1] end
    N > 1 && (c[N] *= (Î±Î²+N)/(Î±Î²+2N-1))
    c
end
#=
function incrementÎ±Î²!(c::AbstractVector,Î±,Î²)
    @assert Î± == Î²
    N = length(c)
    @inbounds for i=1:N-2 c[i] = (2Î±+i-2)*(2Î±+i-1)/(2Î±+2i-1)/(2Î±+2i)*c[i] - (Î±+i+1)/(4Î±+4i+2)*c[i+2] end
    N > 1 && (c[N-1] *= (2Î±+N-3)*(2Î±+N-2)/(2Î±+2N-3)/(2Î±+2N-2))
    N > 2 && (c[N] *= (2Î±+N-2)*(2Î±+N-1)/(2Î±+2N-1)/(2Î±+2N))
    c
end
=#
function decrementÎ±!(c::AbstractVector,Î±,Î²)
    Î±Î²,N = Î±+Î²,length(c)
    N > 1 && (c[N] *= (Î±Î²+2N-2)/(Î±Î²+N-1))
    @inbounds for i=N-1:-1:2 c[i] = (Î±Î²+2i-2)/(Î±Î²+i-1)*c[i] + (Î±Î²+2i-2)/(Î±Î²+2i)*(Î²+i)/(Î±Î²+i-1)*c[i+1] end
    N > 1 && (c[1] += (Î²+1)/(Î±Î²+2)*c[2])
    c
end

function decrementÎ²!(c::AbstractVector,Î±,Î²)
    Î±Î²,N = Î±+Î²,length(c)
    N > 1 && (c[N] *= (Î±Î²+2N-2)/(Î±Î²+N-1))
    @inbounds for i=N-1:-1:2 c[i] = (Î±Î²+2i-2)/(Î±Î²+i-1)*c[i] - (Î±Î²+2i-2)/(Î±Î²+2i)*(Î±+i)/(Î±Î²+i-1)*c[i+1] end
    N > 1 && (c[1] -= (Î±+1)/(Î±Î²+2)*c[2])
    c
end
#=
function decrementÎ±Î²!(c::AbstractVector,Î±,Î²)
    @assert Î± == Î²
    N = length(c)
    N > 1 && (c[N-1] *= (2Î±+2N-5)*(2Î±+2N-4)/(2Î±+N-5)/(2Î±+N-4))
    N > 2 && (c[N] *= (2Î±+2N-3)*(2Î±+2N-2)/(2Î±+N-4)/(2Î±+N-3))
    @inbounds for i=N-2:-1:1 c[i] = (2Î±+2i-3)*(2Î±+2i-2)/(2Î±+i-4)/(2Î±+i-3)*(c[i] + (Î±+i)/(4Î±+4i-2)*c[i+2])  end
    c
end
=#

function modÎ±Î²(Î±)
    if -0.5 < Î± â‰¤ 0.5
        a = Î±
    else
        a = Î±%1
        a > 0.5 && (a-=1)
        a â‰¤ -0.5 && (a+=1)
    end
    a
end

function tosquare!(ret::AbstractVector,Î±,Î²)
    a,b = modÎ±Î²(Î±),modÎ±Î²(Î²)
    A,B = Î±-a,Î²-b
    if Î± â‰¤ -0.5 && Î² â‰¤ -0.5
        incrementÎ±!(ret,Î±,Î²)
        incrementÎ²!(ret,a,Î²)
    elseif Î± â‰¤ -0.5
        incrementÎ±!(ret,Î±,Î²)
        for j=B:-1:1
            decrementÎ²!(ret,a,j+b)
        end
    elseif Î² â‰¤ -0.5
        incrementÎ²!(ret,Î±,Î²)
        for i=A:-1:1
            decrementÎ±!(ret,i+a,b)
        end
    else
        for i=A:-1:1
            decrementÎ±!(ret,i+a,Î²)
        end
        for j=B:-1:1
            decrementÎ²!(ret,a,j+b)
        end
    end
    ret
end

function fromsquare!(ret::AbstractVector,Î±,Î²)
    a,b = modÎ±Î²(Î±),modÎ±Î²(Î²)
    A,B = Î±-a,Î²-b
    if Î± â‰¤ -0.5 && Î² â‰¤ -0.5
        decrementÎ±!(ret,a,b)
        decrementÎ²!(ret,Î±,b)
    elseif Î± â‰¤ -0.5
        decrementÎ±!(ret,a,b)
        for j=0:B-1
            incrementÎ²!(ret,Î±,j+b)
        end
    elseif Î² â‰¤ -0.5
        decrementÎ²!(ret,a,b)
        for i=0:A-1
            incrementÎ±!(ret,i+a,Î²)
        end
    else
        for i=0:A-1
            incrementÎ±!(ret,i+a,b)
        end
        for j=0:B-1
            incrementÎ²!(ret,Î±,j+b)
        end
    end
    ret
end
